# 交通執法小幫手 - 開發紀錄

## 最新更新 (115年2月3日)

### 🧮 執法工具模組 (新功能)

新增「執法工具」模組，提供以下實用功能：

1.  **📅 到案日期計算**
    *   自動顯示「今日」日期 (例如: 115/02/03)
    *   自動計算 **+30日** 到案日期 (例如: 115/03/05)
    *   自動計算 **+45日** 到案日期 (例如: 115/03/20)
    *   格式完全符合台灣交通執法需求 (民國年/月/日)

2.  **🎂 輔助計算工具 (年齡/到案日期)**
    *   **到案日期計算**：顯示今日、+30日、+45日 (民國年)。
    *   **年齡查詢**：
    *   輸入 6碼或7碼 民國生日 (例如: 680101)
    *   自動計算精確年齡 (歲 + 月 + 天)
    *   自動檢查閏年與日期有效性

3.  **🚛 超載計算機 (新功能) - 29-2 條邏輯修正**
    *   **核心功能**：輸入核定/實際總重，自動計算罰鍰、記點與處置。
    *   **29-2 條修正 (Single Rate Tier)**：
        *   ✅ **總超載級距**：若超載 10~20 噸，則 *全部* 超載噸數均乘上 $2,000。
        *   ✅ **無條件進位**：不足 1 噸以 1 噸計算 (Math.ceil)。
    *   **其他邏輯**：
        *   ✅ **寬容值**：未逾 10% 自動判定為「勸導免罰」。
        *   ✅ **整體物品 (無證)**：判斷 29 條固定罰鍰 (3000/4500)。
        *   ✅ **現場處置**：判斷是否超過 20% (當場禁行 vs 2小時修正)。
    *   **UI 更新**：
        *   新增「※ 註釋與判讀標準」區塊，包含核定總重判定、過磅原則、卸貨規定及整體物品特殊規定 (依使用者需求置入)。
    *   **測試驗證**：建立 8 項自動化邏輯測試，涵蓋所有臨界值與級距。

4.  **UI 優化**
    *   全域新增「🏠 回主選單」按鈕，包含所有選擇頁面與結果頁面。
    *   新增「免責聲明」於主選單及結果卡片底部。

**技術實作：**
- 新增 `src/utils/date.js`: 處理民國日期轉換、年齡計算邏輯
- 新增 `src/actions/tools.js`: 執法工具介面與互動邏輯
- 更新 `index.js`: 新增路由 `module=tools` 與文字輸入監聽
- 更新 `src/utils/flex.js`: 主選單新增按鈕

**測試驗證：**
- 建立並執行 `tests/date.test.js`，驗證 8/8 項測試通過。
- 包含跨年、閏年 (民國89年)、格式錯誤檢查。

---

## 最新更新 (115年1月31日)

### 無照駕駛模組 - 法條邏輯修正

**修正項目：**

| 修正內容 | 原法條 | 修正後 | 備註 |
|---------|-------|-------|------|
| 大客車→聯結車 | 21-1條1項4款 | **21條1項4款** | 小型車/機車條款 |
| 大貨車→大客車 | 21條1項4款 | **21-1條1項4款** | 大型車條款 |
| 機車吊銷駕駛機車 | 21條1項3款 | **21條1項4款** | 20處修正 |
| 車種選單 | 含「小型輕型機車」 | 移除，新增「曳引車」 | UI更新 |

### 法條描述完整化

**22條2項 (16處)：**
```
原：駕駛執照逾期 / 駕駛大型重型機車
改：汽車駕駛人領有聯結車、大客車、大貨車、小型車、普通重型或輕型機車駕駛執照，駕駛大型重型機車
```

**22條1項4款 (4處)：**
```
原：持汽車駕照駕駛普通重型機車
改：領有聯結車、大客車、大貨車或小型車駕駛執照，駕駛普通重型機車
```

### 自動化測試套件

**位置：** `tests/violation-matrix.test.js`

**執行方式：**
```bash
node tests/violation-matrix.test.js
```

**測試覆蓋：**
- 關鍵修正驗證 (10項)
- 聯結車駕照 (15項)
- 大客車駕照 (10項)
- 大貨車駕照 (10項)
- 小型車駕照 (15項)
- 汽車駕照吊銷 (8項)
- 汽車駕照吊扣 (6項)
- 無汽車駕照 (14項)
- 完全無照 (7項)
- **總計：81 測試全通過**

---

## 現有模組概覽

| 模組 | 檔案 | 功能 | 狀態 |
|------|------|------|------|
| 無照駕駛 | `src/actions/unlicensed.js` | 21/21-1/22條判定 | ✅ 完成 |
| 酒後駕車 | `src/actions/drunk.js` | 35條判定 | ✅ 完成 |
| 未禮讓/未避讓 | `src/actions/yield.js` | 44/45條判定 | ✅ 完成 |
| 其他違規 | `src/actions/others.js` | 72/78/80/16條 | ✅ 完成 |
| 歡迎訊息 | `src/actions/follow.js` | Follow事件處理 | ✅ 完成 |

---

## 資料結構

### 違規矩陣 (`src/data/violation-matrix.js`)

```javascript
VIOLATION_MATRIX[汽車駕照][機車駕照][駕駛車種] = 結果
```

**汽車駕照狀態：** trailer, bus, truck, small, revoked, suspended, none
**機車駕照狀態：** super, heavy, light, revoked, suspended, none
**車種：** trailer, bus, truck, small_car, super_moto, heavy_moto, light_moto, mini_moto

---

## Git 提交紀錄

```
f0ade2e style: 更名「執法工具」為「輔助計算工具(年齡/到案日期)」
59fecb2 feat: 新增免責聲明於主選單及結果頁面
180d8db feat: 各選擇頁面全域增加「回主選單」按鈕
6609d4c fix: 年齡計算增加「天數」顯示以提高精確度
c7f5235 feat: 新增執法工具模組 (日期/年齡)
ec41bc3 feat: 更新所有法條描述為官方完整格式 + 新增自動化測試套件
f8745b3 fix: 修正 bus.super.trailer 為 21條1項4款
99ca589 fix: 更新法條描述為官方完整格式 (22條1項4款, 22條2項)
```

---

## 待辦事項

- [ ] 驗證 Render 部署後 LINE Bot 功能
- [ ] 確認酒駕模組邏輯與規格書一致
- [ ] 確認禮讓模組邏輯與規格書一致
- [ ] 新增更多測試案例

---

## 開發環境

**Framework:** Bottender + Express
**Node版本:** 22.x (需使用 `npm run dev:custom` 避免相容性問題)
**部署平台:** Render (自動從 master 分支部署)

**本地開發：**
```bash
npm run dev:custom
```

**測試：**
```bash
node tests/violation-matrix.test.js
```
